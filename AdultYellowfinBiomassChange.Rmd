---
title: "AdultYellowfinBiomassChange"
output: html_document
---

| Acknowledgement
| This repository draws on code and uses data from [Bell et al. 2021](https://doi.org/10.1038/s41893-021-00745-z)
| which are found in that paper's repository: <https://osf.io/qa8w4/>

# Purpose
The purpose of this script is to average across models and contributing grid 
cells to create a grid of average percent biomass change for adult yellowfin tuna. 
The min and max values contributing to each grid cell are also gridded. And, 
since it's included in Bell et al. 2021, we'll also note whether all models 
project the same sign change.

```{r}
# Load libraries
library(here)
library(tidyverse, quietly = TRUE)
```

```{r}
# Run script from above repo, with thanks to I. Senina
# This script has a handful of functions that will allow us to read in the 
# SEAPODYM output
source("read_varDYM.R")
```

```{r}
# Load adult yellowfin tuna biomass
# This uses a function that was read in in the above chunk

# Historical data aren't actually used for Fig. 2 in Bell et al. 2021 
# (they end in December 2010 and Fig.2 is 2011-2020 and 2044-2053).
# But we used them to create the gridding.  We can confirm projection grids match
historical_yft_adult <- read.var.dym(here("HISTORICAL 2", "output", "yft_adult.dym"))

# RCP4.5
gfdl_45_yft_adult <- read.var.dym(here("GFDL 2", "REF", "output", "output_F0", "yft_adult.dym"))
ipsl_45_yft_adult <- read.var.dym(here("IPSL 2", "REF", "output", "output_F0", "yft_adult.dym"))
miroc_45_yft_adult <- read.var.dym(here("MIROC 2", "REF", "output", "output_F0", "yft_adult.dym"))
mpi_45_yft_adult <- read.var.dym(here("MPI 2", "REF", "output", "output_F0", "yft_adult.dym"))

# RCP8.5
gfdl_85_yft_adult <- read.var.dym(here("CC 5", "GFDL", "REF", "output", "output_F0", "yft_adult.dym"))
ipsl_85_yft_adult <- read.var.dym(here("CC 6", "IPSL", "REF", "output", "output_F0", "yft_adult.dym"))
miroc_85_yft_adult <- read.var.dym(here("CC 7", "MIROC", "REF", "output", "output_F0", "yft_adult.dym"))
mpi_85_yft_adult <- read.var.dym(here("CC 8", "MPI", "REF", "output", "output_F0", "yft_adult.dym"))
```

```{r}
# Load grid data created using CreateGrid.Rmd
# Remove leading column that just numbers the entries
# We're also going to rename latitude's 'x' to 'y'
lat_edges <- read_csv("lat_HILL_edges4x4.csv", show_col_types = FALSE)
lat_edges <- lat_edges |>
  rename(y = x) |>
  mutate(...1 = NULL)

lon_edges <- read_csv("lon_HILL_edges4x4.csv", show_col_types = FALSE)
lon_edges <- lon_edges |>
  mutate(...1 = NULL)

lat_centers <- read_csv("lat_HILL_centers4x4.csv", show_col_types = FALSE)
lat_centers <- lat_centers |>
  rename(y = x) |>
  mutate(...1 = NULL)

lon_centers <- read_csv("lon_HILL_centers4x4.csv", show_col_types = FALSE)
lon_centers <- lon_centers |>
  mutate(...1 = NULL)
```


```{r}
# Let's test whether each scenario uses the same grid (x-y-t)
test45_x1 <- which(gfdl_45_yft_adult$x == ipsl_45_yft_adult$x)
test45_x2 <- which(gfdl_45_yft_adult$x == miroc_45_yft_adult$x)
test45_x3 <- which(gfdl_45_yft_adult$x == mpi_45_yft_adult$x)
length(gfdl_45_yft_adult$x) == length(test45_x1)
length(gfdl_45_yft_adult$x) == length(test45_x2)
length(gfdl_45_yft_adult$x) == length(test45_x3)

test45_y1 <- which(gfdl_45_yft_adult$y == ipsl_45_yft_adult$y)
test45_y2 <- which(gfdl_45_yft_adult$y == miroc_45_yft_adult$y)
test45_y3 <- which(gfdl_45_yft_adult$y == mpi_45_yft_adult$y)
length(gfdl_45_yft_adult$y) == length(test45_y1)
length(gfdl_45_yft_adult$y) == length(test45_y2)
length(gfdl_45_yft_adult$y) == length(test45_y3)

test45_t1 <- which(gfdl_45_yft_adult$t == ipsl_45_yft_adult$t)
test45_t2 <- which(gfdl_45_yft_adult$t == miroc_45_yft_adult$t)
test45_t3 <- which(gfdl_45_yft_adult$t == mpi_45_yft_adult$t)
length(gfdl_45_yft_adult$t) == length(test45_t1)
length(gfdl_45_yft_adult$t) == length(test45_t2)
length(gfdl_45_yft_adult$t) == length(test45_t3)

test85_x1 <- which(gfdl_85_yft_adult$x == ipsl_85_yft_adult$x)
test85_x2 <- which(gfdl_85_yft_adult$x == miroc_85_yft_adult$x)
test85_x3 <- which(gfdl_85_yft_adult$x == mpi_85_yft_adult$x)
length(gfdl_85_yft_adult$x) == length(test85_x1)
length(gfdl_85_yft_adult$x) == length(test85_x2)
length(gfdl_85_yft_adult$x) == length(test85_x3)

test85_y1 <- which(gfdl_85_yft_adult$y == ipsl_85_yft_adult$y)
test85_y2 <- which(gfdl_85_yft_adult$y == miroc_85_yft_adult$y)
test85_y3 <- which(gfdl_85_yft_adult$y == mpi_85_yft_adult$y)
length(gfdl_85_yft_adult$y) == length(test85_y1)
length(gfdl_85_yft_adult$y) == length(test85_y2)
length(gfdl_85_yft_adult$y) == length(test85_y3)

test85_t1 <- which(gfdl_85_yft_adult$t == ipsl_85_yft_adult$t)
test85_t2 <- which(gfdl_85_yft_adult$t == miroc_85_yft_adult$t)
test85_t3 <- which(gfdl_85_yft_adult$t == mpi_85_yft_adult$t)
length(gfdl_85_yft_adult$t) == length(test85_t1)
length(gfdl_85_yft_adult$t) == length(test85_t2)
length(gfdl_85_yft_adult$t) == length(test85_t3)

# clean up
rm(list=ls(pattern="test"))

# Okay, since all the above statements are true, we know that the RCP4.5 
# scenario data all use the same grid and the RCP8.5 scenario data all use the
# same grid.
# This means we can reference one grid's indices to access all data for that
# scenario and that we can combine data into a single array for easier wrangling.
```

```{r}
# Create empty matrix to fill with lat centroid, lon centroid, and 
# min, mean, max percent biomass change and sign agreement
# I'm sure there's got to be a better way to do this.
Yellowfin_Min_BiomassPercentChange <- matrix(NA, 
                                          nrow = (dim(lat_centers)[1] * dim(lon_centers)[1]),
                                          ncol = 4)
Yellowfin_Min_BiomassPercentChange <- data.frame(Yellowfin_Min_BiomassPercentChange)
colnames(Yellowfin_Min_BiomassPercentChange) <- c("LatCenter", "LonCenter", "RCP4.5", "RCP8.5")

Yellowfin_Mean_BiomassPercentChange <- matrix(NA, 
                                           nrow = (dim(lat_centers)[1] * dim(lon_centers)[1]),
                                           ncol = 4)
Yellowfin_Mean_BiomassPercentChange <- data.frame(Yellowfin_Mean_BiomassPercentChange)
colnames(Yellowfin_Mean_BiomassPercentChange) <- c("LatCenter", "LonCenter", "RCP4.5", "RCP8.5")

Yellowfin_Max_BiomassPercentChange <- matrix(NA, 
                                          nrow = (dim(lat_centers)[1] * dim(lon_centers)[1]),
                                          ncol = 4)
Yellowfin_Max_BiomassPercentChange <- data.frame(Yellowfin_Max_BiomassPercentChange)
colnames(Yellowfin_Max_BiomassPercentChange) <- c("LatCenter", "LonCenter", "RCP4.5", "RCP8.5")

Yellowfin_SignAgreement_BiomassPercentChange <- matrix(NA, 
                                                    nrow = (dim(lat_centers)[1] * dim(lon_centers)[1]),
                                                    ncol = 4)
Yellowfin_SignAgreement_BiomassPercentChange <- data.frame(Yellowfin_SignAgreement_BiomassPercentChange)
colnames(Yellowfin_SignAgreement_BiomassPercentChange) <- c("LatCenter", "LonCenter", "RCP4.5", "RCP8.5")
```

```{r}
### Combine tuna data into a single array for each scenario
# For each model, these are t-x-y

# RCP4.5
rcp45_combined <- array(NA, dim = c(length(gfdl_45_yft_adult$t),
                                    length(gfdl_45_yft_adult$x),
                                    length(gfdl_45_yft_adult$y),
                                    4),
                        dimnames = list("t" = gfdl_45_yft_adult$t,
                                        "x" = gfdl_45_yft_adult$x,
                                        "y" = gfdl_45_yft_adult$y,
                                        "m" = c("GFDL", "IPSL", "MIROC", "MPI")))
rcp45_combined[,,,1] <- gfdl_45_yft_adult$var 
rcp45_combined[,,,2] <- ipsl_45_yft_adult$var
rcp45_combined[,,,3] <- miroc_45_yft_adult$var
rcp45_combined[,,,4] <- mpi_45_yft_adult$var

# RCP8.5
rcp85_combined <- array(NA, dim = c(length(gfdl_85_yft_adult$t),
                                    length(gfdl_85_yft_adult$x),
                                    length(gfdl_85_yft_adult$y),
                                    4),
                        dimnames = list("t" = gfdl_85_yft_adult$t,
                                        "x" = gfdl_85_yft_adult$x,
                                        "y" = gfdl_85_yft_adult$y,
                                        "m" = c("GFDL", "IPSL", "MIROC", "MPI")))
rcp85_combined[,,,1] <- gfdl_85_yft_adult$var 
rcp85_combined[,,,2] <- ipsl_85_yft_adult$var
rcp85_combined[,,,3] <- miroc_85_yft_adult$var
rcp85_combined[,,,4] <- mpi_85_yft_adult$var
```


```{r}
### empty grids to fill
# Time steps of interest
# the RCP4.5 and RCP8.5 grids are different sizes
t_future_idx_45 <- which(gfdl_45_yft_adult$t >= 2044 & gfdl_45_yft_adult$t < 2054)
t_future_idx_85 <- which(gfdl_85_yft_adult$t >= 2044 & gfdl_85_yft_adult$t < 2054)

# RCP4.5
# empty grids to fill
baseline_biomass_45 <- array(NA, dim = c(length(gfdl_45_yft_adult$x),
                                         length(gfdl_45_yft_adult$y),
                                         4),
                             dimnames = list("x" = gfdl_45_yft_adult$x,
                                             "y" = gfdl_45_yft_adult$y,
                                             "m" = c("GFDL", "IPSL", "MIROC", "MPI")))

delta_biomass_45 <- array(NA, dim = c(length(t_future_idx_45),
                                      length(gfdl_45_yft_adult$x),
                                      length(gfdl_45_yft_adult$y),
                                      4),
                          dimnames = list("t" = gfdl_45_yft_adult$t[t_future_idx_45],
                                          "x" = gfdl_45_yft_adult$x,
                                          "y" = gfdl_45_yft_adult$y,
                                          "m" = c("GFDL", "IPSL", "MIROC", "MPI")))


# RCP8.5
# empty grids to fill
baseline_biomass_85 <- array(NA, dim = c(length(gfdl_85_yft_adult$x),
                                         length(gfdl_85_yft_adult$y),
                                         4),
                             dimnames = list("x" = gfdl_85_yft_adult$x,
                                             "y" = gfdl_85_yft_adult$y,
                                             "m" = c("GFDL", "IPSL", "MIROC", "MPI")))

delta_biomass_85 <- array(NA, dim = c(length(t_future_idx_85),
                                      length(gfdl_85_yft_adult$x),
                                      length(gfdl_85_yft_adult$y),
                                      4),
                          dimnames = list("t" = gfdl_85_yft_adult$t[t_future_idx_85],
                                          "x" = gfdl_85_yft_adult$x,
                                          "y" = gfdl_85_yft_adult$y,
                                          "m" = c("GFDL", "IPSL", "MIROC", "MPI")))
```

```{r}
### Calculate baseline values
# Time steps of interest
# the RCP4.5 and RCP8.5 grids are different sizes
t_baseline_idx_45 <- which(gfdl_45_yft_adult$t >= 2011 & gfdl_45_yft_adult$t < 2021)
t_baseline_idx_85 <- which(gfdl_85_yft_adult$t >= 2011 & gfdl_85_yft_adult$t < 2021)

# Loop through each model and grid cell, averaging across all time steps
# RCP4.5
for (cm in seq(1, 4, 1)) {
  for (r in seq(1, length(gfdl_45_yft_adult$y), 1)) {
    for (c in seq(1, length(gfdl_45_yft_adult$x))) {
      # Select period of interest
      base_hold_45 <- rcp45_combined[t_baseline_idx_45, c, r, cm]
      
      baseline_biomass_45[c, r, cm] <- mean(base_hold_45, na.rm = TRUE)
    }
  }
}
# Clean up
rm(base_hold_45, cm, r, c)

# RCP8.5
for (cm in seq(1, 4, 1)) {
  for (r in seq(1, length(gfdl_85_yft_adult$y), 1)) {
    for (c in seq(1, length(gfdl_85_yft_adult$x))) {
      # Select period of interest
      base_hold_85 <- rcp85_combined[t_baseline_idx_85, c, r, cm]
      
      baseline_biomass_85[c, r, cm] <- mean(base_hold_85, na.rm = TRUE)
    }
  }
}

# Clean up
rm(base_hold_85, cm, r, c)
```

```{r}
### Calculate change in biomass
# Loop through each time step, model, and grid cell, noting the percent difference 
# from the baseline (future - baseline)
# the RCP4.5 and RCP8.5 grids are different sizes

# RCP4.5
for (t in seq(1, length(t_future_idx_45), 1)) {
  for (cm in seq(1, 4, 1)) {
    for (r in seq(1, length(gfdl_45_yft_adult$y), 1)) {
      for (c in seq(1, length(gfdl_45_yft_adult$x), 1)) {
        biomass_45_hold <- rcp45_combined[t_future_idx_45[t], c, r, cm]
        
        delta_biomass_45[t, c, r, cm] <- (biomass_45_hold - baseline_biomass_45[c, r, cm]) / baseline_biomass_45[c, r, cm] * 100
      }
    }
  }
}
# Clean up
rm(t, cm, r, c, biomass_45_hold)

# RCP8.5
for (t in seq(1, length(t_future_idx_85), 1)) {
  for (cm in seq(1, 4, 1)) {
    for (r in seq(1, length(gfdl_85_yft_adult$y), 1)) {
      for (c in seq(1, length(gfdl_85_yft_adult$x), 1)) {
        biomass_85_hold <- rcp85_combined[t_future_idx_85[t], c, r, cm]
        
        delta_biomass_85[t, c, r, cm] <- (biomass_85_hold - baseline_biomass_85[c, r, cm]) / baseline_biomass_85[c, r, cm] * 100
      }
    }
  }
}
# Clean up
rm(t, cm, r, c, biomass_85_hold)
```

``` {r}
# loop through new grid cells, pulling info from all four models
# min, mean, max, and sign agreement 
# Truncating percent change a 5 significant figures, which is somewhat arbitrary,
# but more precise than needed.
bpc_counter <- 1 # counter for BiomassPercentChange matrix
for (r in seq(1, dim(lat_centers)[1], 1)) {
  for (c in seq(1, dim(lon_centers)[1], 1)) {
    
    # RCP4.5
    x_idx_45 <- which(gfdl_45_yft_adult$x >= lon_edges$x[c] & gfdl_45_yft_adult$x < lon_edges$x[c+1])
    y_idx_45 <- which(gfdl_45_yft_adult$y >= lat_edges$y[r] & gfdl_45_yft_adult$y < lat_edges$y[r+1])
    
    delta_hold_45 <- delta_biomass_45[, x_idx_45, y_idx_45, ]
    
    Yellowfin_Min_BiomassPercentChange$RCP4.5[bpc_counter] <- signif(min(delta_hold_45, na.rm = TRUE), 5)
    Yellowfin_Mean_BiomassPercentChange$RCP4.5[bpc_counter] <- signif(mean(delta_hold_45, na.rm = TRUE), 5)
    Yellowfin_Max_BiomassPercentChange$RCP4.5[bpc_counter] <- signif(max(delta_hold_45, na.rm = TRUE), 5)
    
    # Looking across 120 time steps, 2 zonal grid cells, 2 meridional grid cells, 4 earth system models
    # 120 x 2 x 2 x 4 = 1920
    if (sum(is.na(delta_hold_45)) + sum(delta_hold_45 > 0, na.rm = TRUE) == 1920 | 
        sum(is.na(delta_hold_45)) + sum(delta_hold_45 > 0, na.rm = TRUE) == 0) {
      Yellowfin_SignAgreement_BiomassPercentChange$RCP4.5[bpc_counter] <- 1
    }
    
    # RCP8.5
    x_idx_85 <- which(gfdl_85_yft_adult$x >= lon_edges$x[c] & gfdl_85_yft_adult$x < lon_edges$x[c+1])
    y_idx_85 <- which(gfdl_85_yft_adult$y >= lat_edges$y[r] & gfdl_85_yft_adult$y < lat_edges$y[r+1])
    
    delta_hold_85 <- delta_biomass_85[, x_idx_85, y_idx_85, ]
    
    Yellowfin_Min_BiomassPercentChange$RCP8.5[bpc_counter] <- signif(min(delta_hold_85, na.rm = TRUE), 5)
    Yellowfin_Mean_BiomassPercentChange$RCP8.5[bpc_counter] <- signif(mean(delta_hold_85, na.rm = TRUE), 5)
    Yellowfin_Max_BiomassPercentChange$RCP8.5[bpc_counter] <- signif(max(delta_hold_85, na.rm = TRUE), 5)
    
    # Looking across 120 time steps, 2 zonal grid cells, 2 meridional grid cells, 4 earth system models
    # 120 x 2 x 2 x 4 = 1920
    if (sum(is.na(delta_hold_85)) + sum(delta_hold_85 > 0, na.rm = TRUE) == 1920 | 
        sum(is.na(delta_hold_85)) + sum(delta_hold_85 > 0, na.rm = TRUE) == 0) {
      Yellowfin_SignAgreement_BiomassPercentChange$RCP8.5[bpc_counter] <- 1
    } 
    
    # The right-hand side of lat & lon fills are being treated as 1x1 tibbles
    # so turning them into numbers
    Yellowfin_Min_BiomassPercentChange$LatCenter[bpc_counter] <- as.numeric(lat_centers[r,1])
    Yellowfin_Mean_BiomassPercentChange$LatCenter[bpc_counter] <- as.numeric(lat_centers[r,1])
    Yellowfin_Max_BiomassPercentChange$LatCenter[bpc_counter] <- as.numeric(lat_centers[r,1])
    Yellowfin_SignAgreement_BiomassPercentChange$LatCenter[bpc_counter] <- as.numeric(lat_centers[r,1])
    
    Yellowfin_Min_BiomassPercentChange$LonCenter[bpc_counter] <- as.numeric(lon_centers[c,1])
    Yellowfin_Mean_BiomassPercentChange$LonCenter[bpc_counter] <- as.numeric(lon_centers[c,1])
    Yellowfin_Max_BiomassPercentChange$LonCenter[bpc_counter] <- as.numeric(lon_centers[c,1])
    Yellowfin_SignAgreement_BiomassPercentChange$LonCenter[bpc_counter] <- as.numeric(lon_centers[c,1])
    
    # Counter
    bpc_counter <- bpc_counter + 1
  }
}
```

```{r}
# Save output
write_csv(Yellowfin_Min_BiomassPercentChange, "Yellowfin_Min_BiomassPercentChange.csv")
write_csv(Yellowfin_Mean_BiomassPercentChange, "Yellowfin_Mean_BiomassPercentChange.csv")
write_csv(Yellowfin_Max_BiomassPercentChange, "Yellowfin_Max_BiomassPercentChange.csv")
write_csv(Yellowfin_SignAgreement_BiomassPercentChange, "Yellowfin_SignAgreement_BiomassPercentChange.csv")
```
